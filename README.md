# CDK Workshop

Hello and thank you for joining us! Today, we are going to deploy an application with 4 microservices using AWS CDK, Amazon ECS, and AWS Fargate.

The Pets Voting Application comprises of
* ["vote"](https://github.com/copilot-example-voting-app/vote), a frontend service that renders an HTML page to vote on cats vs. dogs. This publishes the vote request to a SNS topic, and is fronted by an Application Load Balancer.
* ["processor"](https://github.com/copilot-example-voting-app/processor) microservice is subscribed to that SNS topic using a SQS queue. This asynchronously batches the votes and forwards requests to the "api" service.
* ["api"](https://github.com/copilot-example-voting-app/api) microservice stores and retrieve results on whether a voter prefers cats or dogs. This is a REST API microservice orchestrated by Amazon ECS on AWS Fargate, and is backed up an Amazon Aurora PostgreSQL database for storage.
* ["results"](https://github.com/copilot-example-voting-app/results), a frontend service to visualize the results of the votes. This makes a request to the api service to query the votes. Both the results and vote microservices communicate to api through service discovery.

// TODO: Insert architecture diagram

### Getting started
First `cdk bootstrap aws://{ACCOUNT}/{REGION}`

Then `cdk init --language typescript` to create a new AWS CDK TypeScript project.

There are 2 autogenerated files that we will look into and tweak as the first step. Your appâ€™s entry point is at `bin/cdk-workshop.ts` and `lib/cdk-workshop-stack.ts` is the main infrastructure file. Let's make updates.

### Environment Stack
Let's get setup with the environment stack, and rename `lib/cdk-workshop.ts` to `lib/environment.ts`

* Change the name to VotingEnvironment
* Add EC2 VPC, ECS Cluster, Service Discovery resources 
* npm install
* cdk synth
* cdk deploy

### API Stack
* Create a new `lib/api.ts` for APIService
* Use CDKExtensions to create a new ServiceDescription for `api` microservice
* Add Aurora storage and inject the right secrets and environment variables to api service
* npm install
* cdk synth
* cdk deploy --all

### Vote Stack
* Create a new `lib/vote.ts` for VoteService
* Use CDKExtensions to create a new ServiceDescription for `vote` microservice
* Add SNS Topic and make an accessor for it to be used in `processor` service
* npm install
* cdk synth
* cdk deploy --all

### Processor Stack
* Create a new `lib/vote.ts` for VoteService
* Use CDKExtensions to create a new Queue based ServiceDescription for `processor` microservice
* Use the sns topic from vote as input
* npm install
* cdk synth
* cdk deploy --all

### Results Stack
* Create a new `lib/results.ts` for ResultsService
* Use CDKExtensions to create a new ServiceDescription for `results` microservice and attached a Load Balancer Extension 
* npm install
* cdk synth
* cdk deploy --all
